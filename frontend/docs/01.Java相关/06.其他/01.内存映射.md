---
title: 内存映射
date: 2020-06-12 18:16:18
permalink: /pages/149edb/
categories: 
  - 其他
tags: 
  - 操作系统
---
# 内存映射
映射，顾名思义，就是一一对应的意思，在操作系统层面，内存映射是硬盘上的文件和进程内逻辑地址空间中（相同大小）之间的一个对应关系，这是在逻辑层面的一个对应关系，在真正的物理层面没有对应实现，实现内存映射是操作系统（软件层次）实现的，对于这个一一映射来说，因为进程内的逻辑地址空间本身是我们为了更好的理解内存空间而构造出来的，本身就是不存在的。
* 内存映射的原理：
内存映射的过程，文件数据没有被载入内存，只是逻辑上被载入内存，具体到软件层次实现上，就是建立了一个相对应的数据结构（struct,space_address），这个过程由系统的mmap()函数实现，效率比使用系统调用read(文件),write(文件)函数比较高。
* 内存映射的过程调用：
在开始使用内存映射机制的时候，会调用mmap函数，mmap函数返回一个指针T，这个指针T指向逻辑地址空间中的一个地址，这个地址你可以理解为对应的你要操作的物理文件的地址（但实际上不是），因为访问的是物理文件，所以系统会通过MMU（逻辑地址转换物理地址)机制试图转换成实际的物理地址，在地址映射表中肯定没有相对应的物理地址映射，所以会发生MMU失败，MMU失败导致缺页中断，缺页中断的事件响应函数会在内存交换空间中（SWAP空间）寻找相对应的页面，如果找不到，也就是该文件从来没有被读入过内存，则会通过mmap()建立的映射关系，将物理文件读入用户空间的内存。然后通过这个映射关系，就能直接访问在内存中的物理文件了。
* 为什么内存映射效率高
通常在程序中操作文件，需要将物理文件读入内存，都要经过文件系统的数据拷贝，这个拷贝操作是文件系统和硬件驱动共同实现的，但是普通的拷贝（指read的系统调用），他会将文件内容首先拷贝到物理内存page页，此page页对应的是内核空间缓冲区中的一个地址区域page，然后再将此物理内存复制一份，复制的page此时对应用户空间的一个逻辑地址区域，也就是我们在程序内真正调用的地址。
<!-- more -->